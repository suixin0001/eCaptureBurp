name: Build eCaptureBurp JAR

# 触发条件：推送代码到main/master分支、创建PR、手动触发
on:
  push:
    branches: [ main, master ]
    paths:
      - '**.java'
      - 'pom.xml'
      - '.github/workflows/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - '**.java'
      - 'pom.xml'
      - '.github/workflows/**'
  workflow_dispatch: # 手动触发

jobs:
  build:
    runs-on: ubuntu-latest # 使用Ubuntu最新版运行环境

    steps:
      # 步骤1：检出代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 拉取完整历史（如需版本号相关）

      # 步骤2：设置JDK环境（根据项目实际使用的JDK版本调整）
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '11' # 常用11/8/17，根据pom.xml中的配置调整
          distribution: 'temurin' # 使用Eclipse Temurin JDK
          cache: 'maven' # 缓存Maven依赖，加速构建

      # 步骤3：构建JAR包（Maven）
      - name: Build JAR with Maven
        run: |
          # 清理并打包（跳过测试以加速构建，如需执行测试可移除 -DskipTests）
          mvn clean package -DskipTests
          
          # 输出JAR包路径，方便后续步骤引用
          echo "JAR_PATH=$(find ./target -name '*.jar' -type f | grep -v 'sources\|javadoc\|original' | head -n1)" >> $GITHUB_ENV

      # 步骤4：上传JAR包作为构建产物
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: eCaptureBurp-${{ github.sha }} # 产物名称包含提交哈希
          path: ${{ env.JAR_PATH }}
          retention-days: 30 # 产物保留30天

      # （可选）步骤5：如果是Release触发，自动将JAR包附加到Release
      - name: Upload JAR to Release
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.JAR_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
